---
apiVersion: v1
kind: Service
metadata:
  name: search3-provider-svc
  namespace: {{ .Release.Namespace }}
spec:
  type: ClusterIP
  selector:
    app: system-provider
  ports:
    - name: server
      protocol: TCP
      port: 28080
      targetPort: 28080

---
# provider role
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: backend:search3-provider
  annotations:
    provider-registry-ref: {{ .Release.Namespace }}/search3-provider-svc
    provider-service-ref: search3-provider-svc.{{ .Release.Namespace }}:28080
rules:
  - nonResourceURLs: 
      - "/document/*"
    verbs: ["*"]

---
kind: ConfigMap
apiVersion: v1
metadata:
  name: search3-provider-nginx-config
  namespace: {{ .Release.Namespace }}
  annotations:
    kubesphere.io/creator: bytetrade.io
data:
  search3.conf: |-
    server {
        listen 8080;
        server_name  search3-provider-svc.{{ .Release.Namespace }};
        # Gzip Settings
        gzip on;
        gzip_disable "msie6";
        gzip_min_length 1k;
        gzip_buffers 16 64k;
        gzip_http_version 1.1;
        gzip_comp_level 6;
        gzip_types *;
        index index.html;
        location / {
          proxy_pass http://search3.{{ .Release.Namespace }}:80;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection '$connection_upgrade';
        }
    }

